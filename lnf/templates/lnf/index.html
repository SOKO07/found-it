{% extends "lnf/navbase.html" %}

{% block content %}
{% load static %}
<form method="get" action="{% url 'lnf:index' %}" id="filter-form" class="mb-3">
    <div class="search-bar">
            {{ form.q.label_tag }}<br>
            <input type="text" name="q" placeholder="Item name or location..." id="id_q">
    </div>
    <div>
        <div class="category-checkboxes">
            {% for checkbox in form.categories %}
            <span class="category-item">{{ checkbox }}</span>
            {% endfor %}
        </div>
    </div>
    <div class="options">
        <button type="button" id="toggle-filters-btn">Filters</button>
        <div id="collapsible-filters">
            <div class="d-flex flex-end gap-3">
                <div>
                    {{ form.found_date.label_tag }}<br>
                    {{ form.found_date }}
                </div>
                <div>
                    {{ form.sort_by.label_tag }}<br>
                    {{ form.sort_by }}
                </div>
            </div>
            <div class="checkbox-wrapper">
                {{ form.include_retrieved }}
                <label for="{{ form.include_retrieved.id_for_label }}">{{ form.include_retrieved.label }}</label>
            </div>
        </div>

        <div class="grow"></div>

        <div class="view-toggle-buttons">
            <button type="button" id="list-view-btn" class="view-toggle-btn active"><i class="fa-solid fa-list"></i></button>
            <button type="button" id="grid-view-btn" class="view-toggle-btn"><i class="fa-solid fa-border-all"></i></button>
        </div>
        
    </div>
</form>

<div class="item-list-container {{ view_type }}-view"> {# Dynamically set initial view class #}
    {% include "lnf/partials/_item_list.html" with item_list=item_list view_type=view_type %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const itemListContainer = document.querySelector('.item-list-container');
    const searchInput = form.querySelector('[name="q"]');
    const apiURL = `{% url 'lnf:items_api' %}`;
    const listViewBtn = document.getElementById('list-view-btn');
    const gridViewBtn = document.getElementById('grid-view-btn');

    const toggleBtn = document.getElementById('toggle-filters-btn');
    const filtersContainer = document.getElementById('collapsible-filters');

    if (toggleBtn && filtersContainer) {
        toggleBtn.addEventListener('click', () => {
            filtersContainer.classList.toggle('visible');
        });
    }

    // Function to set view
    function setView(view) {
        if (view === 'grid') {
            itemListContainer.classList.remove('list-view');
            itemListContainer.classList.add('grid-view');
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            localStorage.setItem('viewMode', 'grid');
        } else {
            itemListContainer.classList.remove('grid-view');
            itemListContainer.classList.add('list-view');
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            localStorage.setItem('viewMode', 'list');
        }
        updateItems(); // Call updateItems after changing view
    }

    // View toggling
    listViewBtn.addEventListener('click', () => setView('list'));
    gridViewBtn.addEventListener('click', () => setView('grid'));

    // Apply saved view on page load
    const savedView = localStorage.getItem('viewMode') || 'list';
    setView(savedView); // This call will now trigger updateItems()

    // Debounce function to limit API calls on typing
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    async function updateItems() {
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        
        // Manually handle multiple checkboxes for categories
        const selectedCategories = Array.from(form.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value);
        params.delete('categories'); // Remove default handling
        selectedCategories.forEach(catId => params.append('categories', catId));

        // Add current viewMode to parameters for API call
        params.append('viewMode', localStorage.getItem('viewMode') || 'list'); // Pass current viewMode to API

        const url = `${apiURL}?${params.toString()}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            itemListContainer.innerHTML = data.html;
        } catch (error) {
            console.error('Error fetching items:', error);
            itemListContainer.innerHTML = '<p>Error loading items. Please try again.</p>';
        }
    }

    itemListContainer.addEventListener('click', async function(event) {
        const toggleButton = event.target.closest('.toggle-watch-btn');
        if (toggleButton) {
            event.preventDefault();

            // Check if the item is currently watched and the action will be to unwatch
            if (toggleButton.title === 'Unwatch Item') {
                if (!confirm('Do you really want to unwatch this item?')) {
                    return; // User cancelled the unwatch action
                }
            }

            const url = toggleButton.dataset.toggleUrl;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                const data = await response.json();
                if (data.status === 'ok') {
                    // Toggle 'unhold-button' and 'hold-button' classes
                    if (data.watched) {
                        toggleButton.classList.remove('hold-button');
                        toggleButton.classList.add('unhold-button');
                        toggleButton.title = 'Unwatch Item';
                    } else {
                        toggleButton.classList.remove('unhold-button');
                        toggleButton.classList.add('hold-button');
                        toggleButton.title = 'Watch Item';
                    }

                    // Find the parent .item and toggle the 'is-watched' class
                    const itemElement = toggleButton.closest('.item');
                    if (itemElement) {
                        if (data.watched) {
                            itemElement.classList.add('is-watched');
                        } else {
                            itemElement.classList.remove('is-watched');
                        }
                    }
                    
                    // Optionally, re-sort the items on the client-side or just refresh
                    updateItems(); // This will re-fetch and re-render the whole list
                }
            } catch (error) {
                console.error('Error toggling watch status:', error);
            }
        }
    });

    const debouncedUpdate = debounce(updateItems, 300);

    form.addEventListener('keyup', function(event) {
        if (event.target.name === 'q') {
            debouncedUpdate();
        }
    });

    form.addEventListener('change', function(event) {
        // Handles checkboxes, date picker, and select dropdown
        updateItems();
    });
});
</script>

{% endblock %}